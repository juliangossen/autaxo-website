---
import { Icon } from 'astro-icon/components';

// Styling Konstanten
const cardClass = "bg-[#1a1d26] border border-white/10 rounded-xl p-5 shadow-lg transition-all hover:border-white/20";
const labelClass = "block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide";
const inputClass = "w-full bg-black/30 border border-white/10 text-white rounded-lg p-3 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-colors font-mono text-right";
const selectClass = "w-full bg-black/30 border border-white/10 text-white rounded-lg p-3 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-colors appearance-none cursor-pointer";
---

<div class="max-w-6xl mx-auto my-16 font-sans">
  
  <div class="text-center mb-10">
    <span class="inline-block py-1 px-3 rounded-full bg-primary/10 text-primary text-xs font-bold mb-4 border border-primary/20">
      ðŸš€ PRO TOOL (Kostenlos)
    </span>
    <h2 class="text-3xl md:text-4xl font-bold text-white mb-3">Der HÃ¤ndler-Kalkulator</h2>
    <p class="text-gray-400 max-w-2xl mx-auto">
      Simuliere Einkauf, Verkauf und Steuern in Echtzeit. PrÃ¼fe sofort, wie viel <strong>Netto-Gewinn</strong> dir bleibt und ob du Â§25a anwenden darfst.
    </p>
  </div>

  <div class="grid lg:grid-cols-12 gap-8 items-stretch">
    
    <div class="lg:col-span-5 space-y-6">
      
      <div class={cardClass}>
        <h3 class="text-white font-bold flex items-center gap-2 mb-4">
          <Icon name="lucide:shopping-cart" class="text-primary w-5 h-5" />
          1. Der Einkauf
        </h3>
        
        <div class="space-y-4">
          <div>
            <label class={labelClass}>Einkaufspreis (Brutto)</label>
            <div class="relative">
              <input type="number" id="buy-price" value="10000" class={inputClass} oninput="calc()" />
              <span class="absolute left-3 top-3 text-gray-500">â‚¬</span>
            </div>
          </div>

          <div>
            <label class={labelClass}>Herkunft / VerkÃ¤ufer</label>
            <div class="relative">
              <select id="buy-source" class={selectClass} onchange="calc()">
                <option value="privat">Privatperson (keine MwSt.)</option>
                <option value="klein">Kleinunternehmer (Â§19)</option>
                <option value="hÃ¤ndler_25a">HÃ¤ndler (Differenzbesteuert)</option>
                <option value="regel">Firma / Regelbesteuert (19% Ausweis)</option>
                <option value="eu">EU Import (Netto)</option>
              </select>
              <div class="absolute right-3 top-3.5 pointer-events-none text-gray-500">
                <Icon name="lucide:chevron-down" class="w-4 h-4" />
              </div>
            </div>
            <p id="buy-hint" class="text-xs text-green-400 mt-2 flex items-center gap-1">
              <Icon name="lucide:check-circle" class="w-3 h-3" />
              Automatische Erkennung: Â§25a mÃ¶glich.
            </p>
          </div>
        </div>
      </div>

      <div class={cardClass}>
         <h3 class="text-white font-bold flex items-center gap-2 mb-4">
          <Icon name="lucide:wrench" class="text-blue-400 w-5 h-5" />
          2. Zusatzkosten
        </h3>
        <div>
            <label class={labelClass}>Aufbereitung / Reparatur (Brutto)</label>
            <div class="relative">
              <input type="number" id="cost-price" value="500" class={inputClass} oninput="calc()" />
              <span class="absolute left-3 top-3 text-gray-500">â‚¬</span>
            </div>
            <p class="text-xs text-gray-500 mt-2">Kosten mindern den Gewinn, aber bei Â§25a <span class="text-white font-bold">nicht</span> die Steuerlast!</p>
        </div>
      </div>

      <div class={cardClass}>
        <h3 class="text-white font-bold flex items-center gap-2 mb-4">
          <Icon name="lucide:banknote" class="text-green-400 w-5 h-5" />
          3. Der Verkauf
        </h3>
        
        <div class="space-y-4">
          <div>
            <label class={labelClass}>Verkaufspreis (Brutto)</label>
            <div class="relative">
              <input type="number" id="sell-price" value="13500" class={inputClass} oninput="calc()" />
              <span class="absolute left-3 top-3 text-gray-500">â‚¬</span>
            </div>
          </div>

          <div>
            <label class={labelClass}>Zielgruppe / Land</label>
            <div class="relative">
              <select id="sell-target" class={selectClass} onchange="calc()">
                <option value="de">Deutschland (Inland)</option>
                <option value="eu_b2b">EU HÃ¤ndler (B2B)</option>
                <option value="eu_b2c">EU Privat (B2C)</option>
                <option value="export">Drittland / Export</option>
              </select>
              <div class="absolute right-3 top-3.5 pointer-events-none text-gray-500">
                <Icon name="lucide:chevron-down" class="w-4 h-4" />
              </div>
            </div>
          </div>
          
           <div id="new-car-wrapper" class="hidden pt-3 border-t border-white/10">
              <label class="flex items-start gap-3 cursor-pointer group">
                <input type="checkbox" id="is-new" class="mt-1 w-4 h-4 rounded text-primary bg-gray-700 border-gray-600 focus:ring-primary" onchange="calc()">
                <div>
                  <span class="block text-white text-sm font-bold group-hover:text-primary transition-colors">Ist es ein "Neufahrzeug"?</span>
                  <span class="block text-gray-500 text-xs">< 6 Monate alt oder < 6.000 km</span>
                </div>
              </label>
           </div>
           
           <div id="option-wrapper" class="hidden pt-3 border-t border-white/10">
              <label class="flex items-center justify-between cursor-pointer group">
                <span class="text-xs text-gray-300 group-hover:text-white transition-colors">Auf Â§25a verzichten? (Netto-Rg.)</span>
                <input type="checkbox" id="opt-rule" class="w-4 h-4 rounded text-primary bg-gray-700 border-gray-600" onchange="calc()">
              </label>
           </div>

        </div>
      </div>
    </div>

    <div class="lg:col-span-7 flex flex-col gap-6 h-full">

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-black/40 rounded-xl p-5 border border-white/10 relative overflow-hidden group">
          <p class="text-xs text-gray-400 uppercase font-bold">AbzufÃ¼hrende USt.</p>
          <div class="text-2xl font-bold text-red-400 mt-2 font-mono" id="res-tax">0,00 â‚¬</div>
          <div class="text-xs text-gray-500 mt-1" id="res-tax-detail">auf Marge</div>
        </div>

         <div class="bg-black/40 rounded-xl p-5 border border-white/10 relative overflow-hidden">
          <p class="text-xs text-gray-400 uppercase font-bold">Brutto-Ertrag</p>
          <div class="text-2xl font-bold text-white mt-2 font-mono" id="res-gross-margin">0,00 â‚¬</div>
          <div class="text-xs text-gray-500 mt-1">Verkauf - Einkauf - Kosten</div>
        </div>

        <div id="profit-card" class="bg-[#1a1d26] rounded-xl p-5 border border-white/10 relative overflow-hidden shadow-lg transition-all duration-300">
          <p id="profit-label" class="text-xs text-gray-400 uppercase font-bold transition-colors">Netto-Gewinn</p>
          <div class="text-3xl font-bold text-white mt-2 font-mono transition-colors duration-300" id="res-net-profit">0,00 â‚¬</div>
          <div class="text-xs text-gray-500 mt-1">Das bleibt dir wirklich.</div>
        </div>
      </div>

      <div class="bg-[#1a1d26] rounded-xl border border-white/10 p-6 shadow-lg">
        <h4 class="text-white font-bold mb-4 flex items-center justify-between">
           <span class="flex items-center gap-2"><Icon name="lucide:file-text" class="text-gray-400 w-4 h-4" /> Analyse</span>
           <span id="badge-method" class="px-3 py-1 bg-green-500/20 text-green-400 text-xs font-bold rounded border border-green-500/30">Differenzbesteuerung</span>
        </h4>

        <div class="flex flex-col gap-4">
          <div class="relative group">
            <div id="invoice-text" class="w-full bg-black/50 border border-white/20 rounded-lg p-4 text-sm text-gray-300 font-mono leading-relaxed min-h-[60px] flex items-center pr-10">
              ...
            </div>
             <button onclick="copyText()" class="absolute top-2 right-2 p-2 bg-white/10 hover:bg-primary text-white rounded transition-all" title="Kopieren">
               <Icon name="lucide:copy" class="w-4 h-4" />
             </button>
          </div>

          <div id="knowledge-link" class="hidden p-3 bg-blue-500/5 border border-blue-500/10 rounded-lg flex items-center justify-between group cursor-pointer transition-colors hover:border-blue-500/30 hover:bg-blue-500/10">
             <div class="flex items-center gap-3">
               <div class="p-2 bg-blue-500/20 rounded-full text-blue-400">
                 <Icon name="lucide:book-open" class="w-4 h-4" />
               </div>
               <div>
                 <p class="text-xs text-blue-300 font-bold uppercase mb-0.5">Wissen</p>
                 <p id="knowledge-text" class="text-sm text-gray-300 group-hover:text-white">Lies hier mehr dazu...</p>
               </div>
             </div>
             <a id="knowledge-href" href="#" class="text-blue-400 group-hover:translate-x-1 transition-transform">
               <Icon name="lucide:arrow-right" class="w-5 h-5" />
             </a>
          </div>

          <div id="warning-box" class="hidden p-3 bg-orange-500/10 border border-orange-500/20 rounded-lg flex gap-3 animate-pulse">
             <Icon name="lucide:alert-triangle" class="text-orange-400 w-5 h-5 shrink-0 mt-0.5" />
             <p id="warning-text" class="text-sm text-orange-200"></p>
          </div>
        </div>
      </div>

      <div class="mt-auto bg-gradient-to-r from-primary/20 to-blue-600/10 border border-primary/20 rounded-xl p-6 flex flex-col md:flex-row items-center justify-between gap-4">
        <div>
          <h4 class="text-white font-bold">Zu kompliziert?</h4>
          <p class="text-sm text-gray-400 mt-1">Autaxo macht diese Berechnung automatisch fÃ¼r jedes Auto im Hintergrund.</p>
        </div>
        <a href="https://garage.autaxo.de/auth/sign-up" class="px-5 py-2.5 bg-primary hover:bg-primary-hover text-white font-bold rounded-lg transition-all shadow-lg shadow-primary/20 text-sm whitespace-nowrap">
          Kostenlos testen
        </a>
      </div>

    </div>
  </div>
</div>

<script is:inline>
  // Hilfsfunktion: Formatierung Euro
  const fmt = (num) => {
    return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(num);
  };

  function calc() {
    // 1. INPUTS HOLEN
    const buyPrice = parseFloat(document.getElementById('buy-price').value) || 0;
    const costPrice = parseFloat(document.getElementById('cost-price').value) || 0;
    const sellPrice = parseFloat(document.getElementById('sell-price').value) || 0;
    
    const source = document.getElementById('buy-source').value;
    const target = document.getElementById('sell-target').value;
    const optRule = document.getElementById('opt-rule').checked;

    // Elemente
    const badge = document.getElementById('badge-method');
    const invoiceBox = document.getElementById('invoice-text');
    const warningBox = document.getElementById('warning-box');
    const warningText = document.getElementById('warning-text');
    const optionWrapper = document.getElementById('option-wrapper');
    const buyHint = document.getElementById('buy-hint');
    const newCarWrapper = document.getElementById('new-car-wrapper');
    const isNew = document.getElementById('is-new').checked;
    
    // Knowledge Link Elements
    const kLink = document.getElementById('knowledge-link');
    const kText = document.getElementById('knowledge-text');
    const kHref = document.getElementById('knowledge-href');

    // UI Logic
    if (['eu_b2b', 'eu_b2c'].includes(target)) {
        newCarWrapper.classList.remove('hidden');
    } else {
        newCarWrapper.classList.add('hidden');
    }

    // 2. LOGIK: EINKAUF
    let is25aCapable = false;
    let purchaseVatDeductible = false;

    if (source === 'regel' || source === 'eu') {
      is25aCapable = false;
      purchaseVatDeductible = (source === 'regel'); 
      buyHint.innerHTML = '<span class="text-blue-400 flex items-center gap-1"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg> Regelbesteuerter Einkauf.</span>';
    } else {
      is25aCapable = true;
      purchaseVatDeductible = false;
      buyHint.innerHTML = '<span class="text-green-400 flex items-center gap-1"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg> Automatische Erkennung: Â§25a mÃ¶glich.</span>';
    }

    // 3. LOGIK: VERFAHREN
    let method = is25aCapable ? '25a' : 'regel'; 
    let taxAmount = 0;
    let note = "";
    
    let linkUrl = "/blog/umsatzsteuerfehler-gebrauchtwagenhandel";
    let linkLabel = "Vermeide typische Umsatzsteuerfehler";

    if (is25aCapable && (target === 'eu_b2b' || target === 'export')) {
        optionWrapper.classList.remove('hidden');
        if (optRule) method = 'regel';
    } else {
        optionWrapper.classList.add('hidden');
    }

    if (is25aCapable && isNew && ['eu_b2b', 'eu_b2c'].includes(target)) {
        method = 'regel'; 
    }

    // 4. BERECHNUNG STEUER
    warningBox.classList.add('hidden'); 

    if (method === '25a') {
        badge.innerText = "Differenzbesteuerung (Â§ 25a)";
        badge.className = "px-3 py-1 bg-green-500/20 text-green-400 text-xs font-bold rounded border border-green-500/30";
        
        let margin = sellPrice - buyPrice;
        if (margin < 0) margin = 0;
        
        let taxBase = margin / 1.19;
        taxAmount = margin - taxBase;

        note = "GebrauchtgegenstÃ¤nde/Sonderregelung: Anwendung der Differenzbesteuerung nach Â§ 25a UStG.";
        
        linkUrl = "/blog/differenzbesteuerung-kfz-25a-ustg-guide-eu-fallen";
        linkLabel = "Alles zur Differenzbesteuerung (Â§ 25a) nachlesen";

        if (target === 'eu_b2b') {
             note += " (Kein Hinweis auf steuerfreie igL!)";
             warningBox.classList.remove('hidden');
             warningText.innerText = "Dilemma: Der EU-KÃ¤ufer erhÃ¤lt eine Brutto-Rechnung (keine VSt). Option zur Regelbesteuerung prÃ¼fen, um steuerfrei zu liefern!";
             linkUrl = "/blog/differenzbesteuerung-kfz-25a-ustg-guide-eu-fallen"; 
             linkLabel = "Das EU-Dilemma bei Â§ 25a verstehen";
        } else if (target === 'export') {
            warningBox.classList.remove('hidden');
            warningText.innerText = "Export mit Â§25a ist meist unwirtschaftlich (deutsche USt auf Marge). Mit 'Verzicht auf Â§25a' kÃ¶nntest du steuerfrei (0%) verkaufen.";
            linkUrl = "/blog/fahrzeugverkauf-ins-drittland-umsatzsteuer-ausfuhrnachweis";
            linkLabel = "Export & Drittland richtig abwickeln";
        }

    } else {
        // REGELBESTEUERUNG
        if (target === 'de') {
            badge.innerText = "Regelbesteuerung (19%)";
            badge.className = "px-3 py-1 bg-blue-500/20 text-blue-400 text-xs font-bold rounded border border-blue-500/30";
            taxAmount = sellPrice - (sellPrice / 1.19);
            note = "Rechnungsbetrag enthÃ¤lt 19% Umsatzsteuer.";
        } 
        else if (target === 'eu_b2b' || target === 'export') {
            badge.innerText = "Steuerfrei (0%)";
            badge.className = "px-3 py-1 bg-purple-500/20 text-purple-400 text-xs font-bold rounded border border-purple-500/30";
            taxAmount = 0;
            
            if (target === 'eu_b2b') {
                note = "Steuerfreie innergemeinschaftliche Lieferung (Â§ 4 Nr. 1b i.V.m. Â§ 6a UStG).";
                linkUrl = "/blog/innergemeinschaftliche-lieferung-kfz-steuerfrei";
                linkLabel = "Checkliste: Innergemeinschaftliche Lieferung";
                if(isNew) note = "Steuerfreie innergemeinschaftliche Lieferung eines neuen Fahrzeugs.";
            }
            if (target === 'export') {
                note = "Steuerfreie Ausfuhrlieferung (Â§ 4 Nr. 1a i.V.m. Â§ 6 UStG).";
                linkUrl = "/blog/fahrzeugverkauf-ins-drittland-umsatzsteuer-ausfuhrnachweis";
                linkLabel = "Wichtig: Der MRN-Ausfuhrnachweis";
            }
        }
        else if (target === 'eu_b2c') {
             if (isNew) {
                 badge.innerText = "Steuerfrei (Neufahrzeug)";
                 badge.className = "px-3 py-1 bg-purple-500/20 text-purple-400 text-xs font-bold rounded border border-purple-500/30";
                 taxAmount = 0;
                 note = "Steuerfreie innergemeinschaftliche Lieferung eines neuen Fahrzeugs.";
                 linkUrl = "/blog/innergemeinschaftliche-lieferung-kfz-steuerfrei";
                 linkLabel = "Meldepflicht bei Neufahrzeugen";
             } else {
                 badge.innerText = "Regelbesteuerung (19%)";
                 badge.className = "px-3 py-1 bg-blue-500/20 text-blue-400 text-xs font-bold rounded border border-blue-500/30";
                 taxAmount = sellPrice - (sellPrice / 1.19);
                 note = "Inklusive 19% deutscher Umsatzsteuer.";
             }
        }
    }

    // 5. ERGEBNISSE & FARBLOGIK
    let netBuyPrice = buyPrice;
    if (purchaseVatDeductible) {
        netBuyPrice = buyPrice / 1.19;
    }

    let grossResult = sellPrice - buyPrice - costPrice;
    let netSellPrice = sellPrice - taxAmount;
    let netProfit = netSellPrice - netBuyPrice - costPrice;

    document.getElementById('res-tax').innerText = fmt(taxAmount);
    document.getElementById('res-gross-margin').innerText = fmt(grossResult);
    
    const profitEl = document.getElementById('res-net-profit');
    const profitCard = document.getElementById('profit-card');
    const profitLabel = document.getElementById('profit-label');
    
    profitEl.innerText = fmt(netProfit);
    
    // FARB-LOGIK (Komplettes Feld grÃ¼n/rot)
    if (netProfit < 0) {
        // Verlust: Rot
        profitEl.className = "text-3xl font-bold text-red-500 mt-2 font-mono transition-colors duration-300";
        profitCard.className = "bg-[#1a1d26] rounded-xl p-5 border border-red-500 relative overflow-hidden shadow-lg shadow-red-500/10 transition-all duration-300";
        profitLabel.className = "text-xs text-red-500 uppercase font-bold transition-colors";
    } else {
        // Gewinn: GrÃ¼n (Emerald)
        profitEl.className = "text-3xl font-bold text-emerald-400 mt-2 font-mono transition-colors duration-300";
        profitCard.className = "bg-[#1a1d26] rounded-xl p-5 border border-emerald-500 relative overflow-hidden shadow-lg shadow-emerald-500/10 transition-all duration-300";
        profitLabel.className = "text-xs text-emerald-500 uppercase font-bold transition-colors";
    }

    document.getElementById('invoice-text').innerText = note;
    document.getElementById('res-tax-detail').innerText = (method === '25a') ? "Anteilig aus Marge" : "Aus Verkaufspreis";

    kLink.classList.remove('hidden');
    kText.innerText = linkLabel;
    kLink.onclick = () => window.location.href = linkUrl;
    kHref.href = linkUrl;
  }

  function copyText() {
    navigator.clipboard.writeText(document.getElementById('invoice-text').innerText);
  }

  document.addEventListener('DOMContentLoaded', calc);
</script>