---
import MarketingLayout from '@/layouts/MarketingLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const entries = await getCollection('blog');

  return entries
    .map((entry) => {
      // 1) bevorzugt Frontmatter slug, 2) fallback: Datei-Slug
      const raw = String(entry.data.slug ?? '').trim();
      const slug = raw.length > 0 ? raw.replace(/^\/+|\/+$/g, '') : entry.slug;

      // extra safety: wenn jemand doch /blog/foo/ reinpackt
      const safeSlug = slug.includes('/') ? slug.split('/').filter(Boolean).pop() : slug;

      if (!safeSlug) return null; // verhindert "Missing parameter"
      return { params: { slug: safeSlug }, props: { entry } };
    })
    .filter(Boolean);
}

const { entry } = Astro.props;
const { Content } = await entry.render();

const pageTitle = entry.data.seoTitle ?? entry.data.title;
const pageDesc = entry.data.metaDescription ?? entry.data.excerpt ?? '';
const canonicalUrl = (() => {
  try {
    if (Astro.site) return new URL(Astro.url.pathname, Astro.site).toString();
  } catch (_) {}
  return `https://www.autaxo.de/blog/${entry.data.slug ?? entry.slug}/`;
})();
---
<MarketingLayout title={pageTitle} description={pageDesc} canonicalUrl={canonicalUrl}>
  <article class="bg-[#0b0c10] text-white">
    <div class="container mx-auto px-4 max-w-3xl pt-28 pb-16">
      <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight">{entry.data.title}</h1>
      {pageDesc && <p class="mt-4 text-white/70 text-lg leading-relaxed">{pageDesc}</p>}
      <div class="mt-8 prose prose-invert max-w-none">
        <Content />
      </div>
    </div>
  </article>
</MarketingLayout>
