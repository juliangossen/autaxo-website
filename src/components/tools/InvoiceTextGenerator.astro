---
import { Icon } from 'astro-icon/components';
---

<div class="bg-[#15171e] border border-white/10 rounded-2xl p-6 lg:p-8 max-w-4xl mx-auto shadow-2xl my-12 relative overflow-hidden">
  <div class="absolute top-0 right-0 -mr-20 -mt-20 w-64 h-64 bg-primary/10 rounded-full blur-3xl pointer-events-none"></div>

  <div class="grid lg:grid-cols-2 gap-12">
    
    <div class="space-y-6 relative z-10">
      <div class="mb-6">
        <h3 class="text-2xl font-bold text-white flex items-center gap-3">
          <Icon name="lucide:settings-2" class="text-primary w-6 h-6" />
          Konfiguration
        </h3>
        <p class="text-gray-400 text-sm mt-1">Wähle die Parameter deines Verkaufs.</p>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-300 mb-2">Besteuerung des Fahrzeugs (Einkauf)</label>
        <div class="grid grid-cols-2 gap-3">
          <button type="button" class="select-btn active" data-group="tax" data-value="regel" onclick="selectOption('tax', 'regel', this)">
            Regelbesteuerung (19%)
          </button>
          <button type="button" class="select-btn" data-group="tax" data-value="25a" onclick="selectOption('tax', '25a', this)">
            Differenzbest. (§25a)
          </button>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-300 mb-2">Wohin geht das Fahrzeug?</label>
        <select id="destination" class="w-full bg-black/30 border border-white/20 text-white rounded-lg p-3 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-colors" onchange="updateResult()">
          <option value="de">Deutschland (Inland)</option>
          <option value="eu_b2b">EU-Ausland an Händler (B2B)</option>
          <option value="eu_b2c">EU-Ausland an Privat (B2C)</option>
          <option value="export">Drittland / Export (z.B. Schweiz, Serbien)</option>
        </select>
      </div>

      <div id="new-car-wrapper" class="hidden p-3 bg-white/5 rounded-lg border border-white/10">
        <label class="flex items-start gap-3 cursor-pointer">
          <input type="checkbox" id="is-new" class="mt-1 w-4 h-4 text-primary rounded border-gray-600 focus:ring-primary bg-gray-700" onchange="updateResult()">
          <div>
            <span class="block text-white text-sm font-bold">Ist es ein "Neufahrzeug"?</span>
            <span class="block text-gray-400 text-xs mt-1">Weniger als 6 Monate alt ODER unter 6.000 km.</span>
          </div>
        </label>
      </div>
    </div>

    <div class="bg-black/40 rounded-xl border border-white/10 p-6 flex flex-col relative z-10">
      <div class="flex items-center justify-between mb-4">
        <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider">Ergebnis für die Rechnung</h4>
        <span id="ust-badge" class="px-2 py-1 rounded text-xs font-bold bg-gray-700 text-gray-300">19% MwSt.</span>
      </div>

      <div class="flex-grow bg-[#0b0c10] border border-white/10 rounded-lg p-4 mb-4 relative group">
        <p id="invoice-text" class="text-white font-mono text-sm leading-relaxed min-h-[80px]">
          Bitte wähle links deine Optionen aus...
        </p>
        <button onclick="copyText()" class="absolute top-2 right-2 p-2 bg-white/10 hover:bg-primary text-white rounded-md opacity-0 group-hover:opacity-100 transition-all" title="Kopieren">
          <Icon name="lucide:copy" class="w-4 h-4" />
        </button>
      </div>

      <div id="english-wrapper" class="hidden mb-4">
        <p class="text-xs text-gray-500 mb-1">Englisch (für Export):</p>
        <p id="invoice-text-en" class="text-gray-400 font-mono text-xs italic border-l-2 border-white/20 pl-3">
          -
        </p>
      </div>

      <div id="expert-tip" class="mt-auto pt-4 border-t border-white/10">
        <div class="flex gap-3">
          <div class="shrink-0 mt-0.5">
            <Icon name="lucide:info" class="text-primary w-5 h-5" />
          </div>
          <p id="tip-text" class="text-xs text-gray-400">
            Wähle eine Konfiguration aus.
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .select-btn {
    @apply w-full p-3 rounded-lg border border-white/20 text-white text-sm font-medium transition-all text-left hover:bg-white/5;
  }
  .select-btn.active {
    @apply border-primary bg-primary/10 text-primary ring-1 ring-primary;
  }
</style>

<script is:inline>
  let state = {
    tax: 'regel', // 'regel' or '25a'
    destination: 'de',
    isNew: false
  };

  function selectOption(group, value, btn) {
    state[group] = value;
    // UI Update Buttons
    document.querySelectorAll(`button[data-group="${group}"]`).forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    updateResult();
  }

  function updateResult() {
    // Hole Werte aus Select/Checkbox
    state.destination = document.getElementById('destination').value;
    state.isNew = document.getElementById('is-new').checked;

    // Logik-Variablen
    const output = document.getElementById('invoice-text');
    const outputEn = document.getElementById('invoice-text-en');
    const badge = document.getElementById('ust-badge');
    const tip = document.getElementById('tip-text');
    const enWrapper = document.getElementById('english-wrapper');
    const newCarWrapper = document.getElementById('new-car-wrapper');

    // Reset UI
    enWrapper.classList.add('hidden');
    
    // Checkbox Sichtbarkeit (Nur bei EU relevant)
    if (state.destination === 'eu_b2b' || state.destination === 'eu_b2c') {
      newCarWrapper.classList.remove('hidden');
    } else {
      newCarWrapper.classList.add('hidden');
      state.isNew = false; // Reset wenn ausgeblendet
    }

    // --- LOGIK START ---

    // FALL 1: Differenzbesteuerung (§25a) gewählt
    if (state.tax === '25a') {
      badge.innerText = "Kein USt-Ausweis";
      badge.className = "px-2 py-1 rounded text-xs font-bold bg-orange-500/20 text-orange-400 border border-orange-500/30";
      
      let text = "Gebrauchtgegenstände/Sonderregelung: Anwendung der Differenzbesteuerung nach § 25a UStG.";
      let tipText = "Bei § 25a darf KEINE Umsatzsteuer ausgewiesen werden.";

      if (state.destination === 'eu_b2b') {
        tipText += " Achtung: Keine steuerfreie igL möglich, wenn § 25a angewendet wird!";
      } else if (state.destination === 'export') {
         tipText += " Auch beim Export bleibt es bei der Differenzbesteuerung (keine Steuerbefreiung als Ausfuhrlieferung, außer durch Optionsverzicht).";
      }

      output.innerText = text;
      outputEn.innerText = "Margin Scheme - Second-hand goods.";
      if(state.destination !== 'de') enWrapper.classList.remove('hidden');
      tip.innerText = tipText;
      return; 
    }

    // FALL 2: Regelbesteuerung (19%)

    // 2.1 Inland
    if (state.destination === 'de') {
      badge.innerText = "19% MwSt.";
      badge.className = "px-2 py-1 rounded text-xs font-bold bg-blue-500/20 text-blue-400 border border-blue-500/30";
      output.innerText = "Standard-Rechnung mit Ausweis von 19% Umsatzsteuer.";
      tip.innerText = "Ganz normaler Verkauf im Inland.";
      return;
    }

    // 2.2 EU Ausland (B2B)
    if (state.destination === 'eu_b2b') {
      badge.innerText = "Steuerfrei (0%)";
      badge.className = "px-2 py-1 rounded text-xs font-bold bg-green-500/20 text-green-400 border border-green-500/30";
      
      output.innerText = "Steuerfreie innergemeinschaftliche Lieferung gemäß § 4 Nr. 1b i.V.m. § 6a UStG.";
      outputEn.innerText = "Tax-free intra-Community supply pursuant to Art. 138 Directive 2006/112/EC.";
      enWrapper.classList.remove('hidden');
      tip.innerText = "Wichtig: Gültige USt-IdNr. des Käufers prüfen + Gelangensbestätigung einholen + ZM Meldung nicht vergessen.";
      return;
    }

    // 2.3 EU Ausland (B2C - Privat)
    if (state.destination === 'eu_b2c') {
      if (state.isNew) {
        // Sonderfall: Neufahrzeug an Privat
        badge.innerText = "Steuerfrei (0%)";
        badge.className = "px-2 py-1 rounded text-xs font-bold bg-purple-500/20 text-purple-400 border border-purple-500/30";
        output.innerText = "Steuerfreie innergemeinschaftliche Lieferung eines neuen Fahrzeugs (§ 2a UStG). Die Erwerbsbesteuerung erfolgt im Bestimmungsland.";
        outputEn.innerText = "Tax-free intra-Community supply of a new means of transport.";
        enWrapper.classList.remove('hidden');
        tip.innerText = "Achtung: Sonderfall! Meldepflicht Fahrzeuglieferung beachten. Käufer muss im Zielland Steuer zahlen.";
      } else {
        // Normalfall: Gebrauchtwagen an Privat
        badge.innerText = "19% MwSt. (DE)";
        badge.className = "px-2 py-1 rounded text-xs font-bold bg-blue-500/20 text-blue-400 border border-blue-500/30";
        output.innerText = "Rechnung mit 19% deutscher Umsatzsteuer (Regelbesteuerung).";
        tip.innerText = "Bei Lieferung an Privatpersonen gilt grundsätzlich das Ursprungslandprinzip (deutsche USt), sofern Lieferschwellen (OSS) nicht überschritten sind.";
      }
      return;
    }

    // 2.4 Drittland / Export
    if (state.destination === 'export') {
      badge.innerText = "Steuerfrei (0%)";
      badge.className = "px-2 py-1 rounded text-xs font-bold bg-green-500/20 text-green-400 border border-green-500/30";
      
      output.innerText = "Steuerfreie Ausfuhrlieferung gemäß § 4 Nr. 1a i.V.m. § 6 UStG.";
      outputEn.innerText = "Tax-free export supply pursuant to Art. 146 Directive 2006/112/EC.";
      enWrapper.classList.remove('hidden');
      tip.innerText = "Zwingend erforderlich: Ausfuhrnachweis (Ausgangsvermerk mit MRN). Ohne MRN keine Steuerfreiheit!";
      return;
    }
  }

  function copyText() {
    const text = document.getElementById('invoice-text').innerText;
    navigator.clipboard.writeText(text);
    
    // Visuelles Feedback
    const btn = document.querySelector('button[title="Kopieren"]');
    btn.classList.add('bg-green-500', 'text-white');
    setTimeout(() => {
      btn.classList.remove('bg-green-500', 'text-white');
    }, 1000);
  }

  // Init
  document.addEventListener('DOMContentLoaded', updateResult);
</script>