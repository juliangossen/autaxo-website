---
// src/components/tools/MarginCalculator.astro
---

<div class="grid grid-cols-1 xl:grid-cols-12 gap-8 items-stretch">
        
  <div class="xl:col-span-5 bg-slate-900/50 rounded-2xl border border-white/10 p-6 md:p-8 backdrop-blur-sm shadow-xl h-full flex flex-col">
    <div class="flex items-center justify-between mb-6 flex-none">
      <h2 class="text-xl font-bold text-white flex items-center gap-2">
        <span class="w-8 h-8 rounded-lg bg-blue-600/20 text-blue-400 flex items-center justify-center text-sm">1</span>
        Kalkulation
      </h2>
      <button id="btn-reset" class="text-xs text-slate-500 hover:text-white transition-colors cursor-pointer underline decoration-slate-700">
        Alles zurücksetzen
      </button>
    </div>

    <div class="space-y-6 flex-grow">
      <div>
        <label for="input-ek" class="block text-sm font-medium text-slate-400 mb-2">Einkaufspreis (Brutto)</label>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <span class="text-slate-500">€</span>
          </div>
          <input type="number" id="input-ek" placeholder="10000" class="block w-full pl-8 pr-4 py-3 bg-slate-950 border border-slate-700 rounded-lg text-white placeholder-slate-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all outline-none" />
        </div>
      </div>

      <div>
        <label for="input-vk" class="block text-sm font-medium text-slate-400 mb-2">Geplanter Verkaufspreis (Brutto)</label>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <span class="text-slate-500">€</span>
          </div>
          <input type="number" id="input-vk" placeholder="13900" class="block w-full pl-8 pr-4 py-3 bg-slate-950 border border-slate-700 rounded-lg text-white placeholder-slate-600 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all outline-none" />
        </div>
      </div>

      <div class="border-t border-white/5 pt-4"></div>

      <div class="grid grid-cols-12 gap-4">
        <div class="col-span-8">
           <label for="input-cost" class="block text-sm font-medium text-slate-400 mb-2">Weitere Kosten (Teile, Werkstatt)</label>
           <div class="relative">
             <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
               <span class="text-slate-500">€</span>
             </div>
             <input type="number" id="input-cost" placeholder="500" class="block w-full pl-8 pr-4 py-3 bg-slate-950 border border-slate-700 rounded-l-lg text-white placeholder-slate-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all outline-none" />
           </div>
        </div>
        
        <div class="col-span-4">
            <div class="flex items-center gap-1 mb-2">
                <label class="block text-sm font-medium text-slate-400">Eingabe ist</label>
                <div class="group relative cursor-help">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-500 hover:text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                    <div class="hidden group-hover:block absolute bottom-full right-0 mb-2 w-48 bg-slate-800 border border-white/10 text-xs text-slate-300 p-3 rounded-lg shadow-xl z-20">
                        <strong>Netto:</strong> Du gibst den Betrag ohne USt ein (für B2B-Kosten).<br/><br/>
                        <strong>Brutto:</strong> Du gibst den Betrag inkl. USt ein. Wir rechnen die VSt (19%) für dich raus.
                    </div>
                </div>
            </div>
            
            <div class="relative h-[50px] bg-slate-950 border border-slate-700 rounded-r-lg flex p-1">
                <button type="button" class="cost-type-btn flex-1 rounded text-xs font-bold transition-all bg-slate-700 text-white" data-type="netto">Netto</button>
                <button type="button" class="cost-type-btn flex-1 rounded text-xs font-medium text-slate-500 hover:text-white transition-all" data-type="brutto">Brutto</button>
            </div>
            <input type="hidden" id="input-cost-type" value="netto">
        </div>
      </div>
      
      <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="input-date" class="block text-sm font-medium text-slate-400 mb-2">Im Bestand seit</label>
            <input type="date" id="input-date" class="block w-full px-3 py-3 bg-slate-950 border border-slate-700 rounded-lg text-white placeholder-slate-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all outline-none text-sm" />
          </div>

          <div>
             <label for="input-days" class="block text-sm font-medium text-slate-400 mb-2">Standtage (Gesamt)</label>
             <div class="relative">
                <input type="number" id="input-days" value="30" class="block w-full px-3 py-3 bg-slate-950 border border-slate-700 rounded-lg text-white placeholder-slate-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all outline-none text-sm" />
                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                   <span class="text-xs text-slate-500">Tage</span>
                </div>
             </div>
          </div>
      </div>
      
      <div>
        <label for="input-interest-rate" class="block text-sm font-medium text-slate-400 mb-2">Kalkulatorischer Zinssatz (p.a.)</label>
        <div class="relative">
             <input type="number" id="input-interest-rate" value="6.0" step="0.1" class="block w-full pl-3 pr-8 py-2 bg-slate-950 border border-slate-700 rounded-lg text-white placeholder-slate-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all outline-none text-sm" />
             <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                <span class="text-slate-500">%</span>
             </div>
        </div>
        <p class="text-[10px] text-slate-500 mt-1">Zins für gebundenes Kapital (EK + Kosten).</p>
      </div>

    </div>
  </div>

  <div class="xl:col-span-7 flex flex-col h-full gap-6">
    
    <div class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-2xl border border-white/10 p-8 relative overflow-hidden flex-none">
      <div id="glow-bg" class="absolute top-0 right-0 w-64 h-64 bg-emerald-500/5 rounded-full blur-3xl transform translate-x-1/2 -translate-y-1/2 transition-colors duration-500"></div>
      
      <div class="relative z-10">
        <div class="flex justify-between items-start">
            <div>
                <span class="text-slate-400 text-sm font-medium uppercase tracking-wider">Dein Reingewinn (Netto)</span>
                <div class="flex items-baseline gap-2 mt-2">
                <span id="output-profit" class="text-5xl font-bold text-emerald-400 transition-colors">0,00 €</span>
                </div>
                <p class="text-slate-500 text-sm mt-3">Nach Steuern, Kosten und Zinsen.</p>
            </div>
            <div id="output-roi-badge" class="bg-slate-800 text-slate-400 text-sm font-bold px-3 py-1.5 rounded border border-white/5">
                ROI: 0.0%
            </div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 flex-1">
      
      <div class="bg-slate-900/50 rounded-xl border border-white/5 p-5 flex flex-col justify-between h-full">
        <span class="text-slate-500 text-xs uppercase font-bold">Brutto-Marge (Handelsspanne)</span>
        <div id="output-gross-margin" class="text-2xl font-bold text-white mt-2">0,00 €</div>
      </div>

      <div class="bg-slate-900/50 rounded-xl border border-white/5 p-5 flex flex-col justify-between relative overflow-hidden h-full">
        <div class="absolute inset-y-0 left-0 w-1 bg-red-500/50"></div>
        <span class="text-slate-400 text-xs uppercase font-bold flex items-center gap-1">
          Finanzamt (USt §25a)
        </span>
        <div id="output-tax" class="text-2xl font-bold text-red-400 mt-2">0,00 €</div>
      </div>

       <div class="bg-slate-900/50 rounded-xl border border-white/5 p-5 flex flex-col justify-between h-full">
        <span class="text-slate-500 text-xs uppercase font-bold">Kapitalkosten (Zinsen)</span>
        <div id="output-interest" class="text-xl font-semibold text-slate-300 mt-2">- 0,00 €</div>
      </div>

      <div class="bg-slate-900/50 rounded-xl border border-white/5 p-5 flex flex-col justify-between h-full">
        <span class="text-slate-500 text-xs uppercase font-bold">Weitere Kosten (Netto)</span>
        <div id="output-costs" class="text-xl font-semibold text-slate-300 mt-2">- 0,00 €</div>
      </div>

    </div>

    <div class="bg-slate-900/30 rounded-xl border border-white/5 p-4 flex-none">
        <div class="flex justify-between text-[10px] uppercase text-slate-500 mb-2 font-bold">
            <span>Verteilung des Verkaufspreises</span>
        </div>
        <div class="h-4 w-full bg-slate-800 rounded-full flex overflow-hidden">
             <div class="bg-slate-600 h-full w-[10%]" title="Einkauf" style="flex-grow:1"></div>
             <div id="vis-cost" class="bg-orange-500/70 h-full transition-all duration-500" style="width: 0%" title="Kosten"></div>
             <div id="vis-tax" class="bg-red-500/70 h-full transition-all duration-500" style="width: 0%" title="Steuer"></div>
             <div id="vis-interest" class="bg-purple-500/70 h-full transition-all duration-500" style="width: 0%" title="Zins"></div>
             <div id="vis-profit" class="bg-emerald-500 h-full transition-all duration-500" style="width: 0%" title="Gewinn"></div>
        </div>
        <div class="flex gap-4 mt-2 justify-end">
            <div class="flex items-center gap-1.5">
                <div class="w-2 h-2 rounded-full bg-orange-500/70"></div>
                <span class="text-[10px] text-slate-400">Kosten</span>
            </div>
            <div class="flex items-center gap-1.5">
                <div class="w-2 h-2 rounded-full bg-red-500/70"></div>
                <span class="text-[10px] text-slate-400">Steuer</span>
            </div>
            <div class="flex items-center gap-1.5">
                <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
                <span class="text-[10px] text-slate-400">Gewinn</span>
            </div>
        </div>
    </div>

  </div>
</div>

<script>
  // Elements
  const inputs = {
    ek: document.getElementById('input-ek') as HTMLInputElement,
    vk: document.getElementById('input-vk') as HTMLInputElement,
    cost: document.getElementById('input-cost') as HTMLInputElement,
    days: document.getElementById('input-days') as HTMLInputElement,
    date: document.getElementById('input-date') as HTMLInputElement,
    interestRate: document.getElementById('input-interest-rate') as HTMLInputElement,
    costType: document.getElementById('input-cost-type') as HTMLInputElement,
  };

  const outputs = {
    profit: document.getElementById('output-profit'),
    roiBadge: document.getElementById('output-roi-badge'),
    grossMargin: document.getElementById('output-gross-margin'),
    tax: document.getElementById('output-tax'),
    interest: document.getElementById('output-interest'),
    costs: document.getElementById('output-costs'),
    visCost: document.getElementById('vis-cost'),
    visInterest: document.getElementById('vis-interest'),
    visTax: document.getElementById('vis-tax'),
    visProfit: document.getElementById('vis-profit'),
    glowBg: document.getElementById('glow-bg'),
  };

  const costTypeBtns = document.querySelectorAll('.cost-type-btn');

  // Helper: Format JS Date to YYYY-MM-DD
  function formatDateToInput(date: Date) {
      return date.toISOString().split('T')[0];
  }

  // --- Init ---
  // Set initial date based on default days (30)
  if(inputs.days && inputs.days.value) {
      const initDate = new Date();
      initDate.setDate(initDate.getDate() - parseInt(inputs.days.value));
      inputs.date.value = formatDateToInput(initDate);
  }

  // --- Toggle Logic ---
  costTypeBtns.forEach(btn => {
      btn.addEventListener('click', (e) => {
          const target = e.target as HTMLElement;
          const type = target.dataset.type;
          
          inputs.costType.value = type || 'netto';
          
          costTypeBtns.forEach(b => {
             b.classList.remove('bg-slate-700', 'text-white', 'font-bold');
             b.classList.add('text-slate-500', 'font-medium');
          });
          target.classList.add('bg-slate-700', 'text-white', 'font-bold');
          target.classList.remove('text-slate-500', 'font-medium');

          calculate(); 
      });
  });

  // --- Smart Sync Logic ---
  
  // 1. Change Date -> Update Days
  inputs.date?.addEventListener('change', () => {
     if(inputs.date.value) {
        const start = new Date(inputs.date.value);
        const now = new Date();
        const diffTime = Math.abs(now.getTime() - start.getTime());
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        // Prevent negative days if future date selected
        inputs.days.value = diffDays > 0 ? diffDays.toString() : "0";
        calculate();
     }
  });

  // 2. Change Days -> Update Date
  inputs.days?.addEventListener('input', () => {
      if(inputs.days.value) {
          const days = parseInt(inputs.days.value);
          const newDate = new Date();
          newDate.setDate(newDate.getDate() - days);
          inputs.date.value = formatDateToInput(newDate);
          calculate();
      }
  });

  function formatCurrency(num: number) {
    return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(num);
  }

  function calculate() {
    const ek = parseFloat(inputs.ek.value) || 0;
    const vk = parseFloat(inputs.vk.value) || 0;
    let costInput = parseFloat(inputs.cost.value) || 0;
    const days = parseFloat(inputs.days.value) || 0;
    const interestRateVal = parseFloat(inputs.interestRate.value) || 6.0;
    const costType = inputs.costType.value;

    if (ek === 0 || vk === 0) return;

    // 1. Kosten Normalisierung (Wir rechnen intern immer Netto)
    let realCost = costInput;
    if (costType === 'brutto') {
        realCost = costInput / 1.19;
    }

    // 2. Brutto Marge
    const grossMargin = vk - ek;

    // 3. Umsatzsteuer
    let tax = 0;
    if (grossMargin > 0) {
      tax = (grossMargin / 1.19) * 0.19;
    }

    // 4. Kalkulatorische Zinskosten
    const capitalBound = ek + realCost;
    const interestRateDecimal = interestRateVal / 100;
    const interestCost = (capitalBound * interestRateDecimal * days) / 360;

    // 5. Reingewinn
    const netMargin = grossMargin - tax;
    const profit = netMargin - realCost - interestCost;

    // 6. ROI
    const totalInvest = ek + realCost + interestCost + tax; 
    let roi = 0;
    if (totalInvest > 0) {
        roi = (profit / totalInvest) * 100;
    }

    // --- RENDER ---
    if(outputs.profit) {
        outputs.profit.textContent = formatCurrency(profit);
        if(profit < 0) {
            outputs.profit.classList.remove('text-emerald-400');
            outputs.profit.classList.add('text-red-400');
        } else {
            outputs.profit.classList.add('text-emerald-400');
            outputs.profit.classList.remove('text-red-400');
        }
    }
    
    if(outputs.grossMargin) outputs.grossMargin.textContent = formatCurrency(grossMargin);
    if(outputs.tax) outputs.tax.textContent = "- " + formatCurrency(tax);
    if(outputs.interest) outputs.interest.textContent = "- " + formatCurrency(interestCost);
    if(outputs.costs) outputs.costs.textContent = "- " + formatCurrency(realCost);

    // ROI Badge
    if(outputs.roiBadge) {
        outputs.roiBadge.textContent = `ROI: ${roi.toFixed(1)}%`;
        outputs.roiBadge.className = "text-sm font-bold px-3 py-1.5 rounded border border-white/5 transition-colors";
        
        if (roi < 0) {
            outputs.roiBadge.classList.add('bg-red-500/20', 'text-red-400', 'border-red-500/30');
            outputs.glowBg?.classList.replace('bg-emerald-500/5', 'bg-red-500/10');
        } else if (roi < 5) {
            outputs.roiBadge.classList.add('bg-yellow-500/20', 'text-yellow-400', 'border-yellow-500/30');
            outputs.glowBg?.classList.replace('bg-red-500/10', 'bg-yellow-500/10');
        } else {
            outputs.roiBadge.classList.add('bg-emerald-500/20', 'text-emerald-400', 'border-emerald-500/30');
            outputs.glowBg?.classList.replace('bg-yellow-500/10', 'bg-emerald-500/5');
            outputs.glowBg?.classList.replace('bg-red-500/10', 'bg-emerald-500/5');
        }
    }

    // Vis Bars
    const percentCost = (realCost / vk) * 100;
    const percentInterest = (interestCost / vk) * 100;
    const percentTax = (tax / vk) * 100;
    const percentProfit = (profit > 0) ? (profit / vk) * 100 : 0;

    if(outputs.visCost) outputs.visCost.style.width = `${percentCost}%`;
    if(outputs.visInterest) outputs.visInterest.style.width = `${percentInterest}%`;
    if(outputs.visTax) outputs.visTax.style.width = `${percentTax}%`;
    if(outputs.visProfit) outputs.visProfit.style.width = `${percentProfit}%`;
  }

  // Event Listeners
  [inputs.ek, inputs.vk, inputs.cost, inputs.days, inputs.interestRate].forEach(el => {
    el?.addEventListener('input', calculate);
  });

  document.getElementById('btn-reset')?.addEventListener('click', () => {
    inputs.ek.value = "";
    inputs.vk.value = "";
    inputs.cost.value = "";
    inputs.days.value = "30";
    
    // Reset Date
    const resetDate = new Date();
    resetDate.setDate(resetDate.getDate() - 30);
    inputs.date.value = formatDateToInput(resetDate);

    inputs.interestRate.value = "6.0";
    
    // Reset switch
    inputs.costType.value = "netto";
    costTypeBtns.forEach(b => {
        b.classList.remove('bg-slate-700', 'text-white', 'font-bold');
        b.classList.add('text-slate-500', 'font-medium');
        if(b.dataset.type === 'netto') {
            b.classList.add('bg-slate-700', 'text-white', 'font-bold');
            b.classList.remove('text-slate-500', 'font-medium');
        }
    });
    calculate();
  });
</script>