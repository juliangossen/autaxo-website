---
import MarketingLayout from "@/layouts/MarketingLayout.astro";
import { Icon } from "astro-icon/components";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const entries = await getCollection("blog");

  // WICHTIG: für params.slug ausschließlich entry.slug verwenden (kommt immer aus dem Dateisystem)
  return entries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

const fallbackImage = "/og/autaxo-og.png";

// SEO
const seoTitle = entry.data.seoTitle ?? entry.data.title;
const metaDescription =
  entry.data.metaDescription ?? entry.data.description ?? entry.data.excerpt ?? "";

// Schema nutzt z.coerce.date() -> hier ist publishedDate ein Date-Objekt
const publishedDate =
  entry.data.publishedDate instanceof Date
    ? entry.data.publishedDate
    : new Date(entry.data.publishedDate);

const isoPublished = isNaN(publishedDate.getTime())
  ? undefined
  : publishedDate.toISOString();

const canonicalUrl = (() => {
  try {
    if (Astro.site) return new URL(Astro.url.pathname, Astro.site).toString();
  } catch (_) {}
  return `https://www.autaxo.de/blog/${entry.slug}/`;
})();

const coverImage =
  (typeof entry.data.coverImage === "string" && entry.data.coverImage.trim())
    ? entry.data.coverImage.trim()
    : fallbackImage;

// JSON-LD (BlogPosting)
const structuredData = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": entry.data.title,
  "description": entry.data.description,
  "author": entry.data.author
    ? { "@type": "Person", "name": entry.data.author }
    : undefined,
  "datePublished": isoPublished,
  "image": coverImage.startsWith("http")
    ? coverImage
    : `https://www.autaxo.de${coverImage}`,
  "mainEntityOfPage": canonicalUrl,
};
---

<MarketingLayout
  title={seoTitle}
  description={metaDescription}
  canonicalUrl={canonicalUrl}
  image={coverImage}
>
  <Fragment slot="head">
    <script
      type="application/ld+json"
      set:html={JSON.stringify(structuredData)}
    />
  </Fragment>

  <main class="bg-[#0b0c10] pt-28 pb-24">
    <div class="container mx-auto px-4 max-w-3xl">
      <nav class="text-sm text-white/60 mb-6">
        <a href="/blog/" class="hover:text-white underline">Blog</a>
        <span class="mx-2">/</span>
        <span class="text-white/80">{entry.data.title}</span>
      </nav>

      <header class="mb-8">
        <h1 class="text-3xl md:text-4xl font-extrabold text-white leading-tight">
          {entry.data.title}
        </h1>

        <div class="mt-4 flex flex-wrap gap-2 text-xs">
          {isoPublished && (
            <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-white/5 border border-white/10 text-white/70">
              <Icon name="lucide:calendar" class="w-3.5 h-3.5 text-white/40" />
              {publishedDate.toLocaleDateString("de-DE", {
                year: "numeric",
                month: "long",
                day: "2-digit",
              })}
            </span>
          )}

          {Array.isArray(entry.data.tags) &&
            entry.data.tags.slice(0, 6).map((t) => (
              <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-white/5 border border-white/10 text-white/70">
                <Icon name="lucide:tag" class="w-3.5 h-3.5 text-white/40" />
                {t}
              </span>
            ))}
        </div>

        {entry.data.shortDefinition && (
          <div class="mt-6 rounded-2xl border border-white/10 bg-[#15171e] p-5 text-white/75">
            <div class="flex items-center gap-2 mb-2">
              <Icon name="lucide:info" class="w-4 h-4 text-primary" />
              <p class="m-0 font-bold text-white">Kurzdefinition</p>
            </div>
            <p class="m-0 leading-relaxed">{entry.data.shortDefinition}</p>
          </div>
        )}
      </header>

      <article class="prose prose-invert max-w-none">
        <Content />
      </article>

      <div class="mt-10 pt-8 border-t border-white/10">
        <a
          href="/blog/"
          class="inline-flex items-center gap-2 text-primary font-bold hover:opacity-90"
        >
          <Icon name="lucide:arrow-left" class="w-4 h-4" />
          Zurück zum Blog
        </a>
      </div>
    </div>
  </main>
</MarketingLayout>
