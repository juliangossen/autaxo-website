---
import MarketingLayout from "@/layouts/MarketingLayout.astro";
import { Icon } from "astro-icon/components";
import { getCollection } from "astro:content";

const title = "Autaxo Blog: §25a, DATEV, GoBD & EU/Export im Gebrauchtwagenhandel";
const description =
  "Praxiswissen für Gebrauchtwagenhändler in Deutschland: Differenzbesteuerung (§25a UStG), EU/Export-Nachweise, GoBD-Dokumentation, DATEV-Export und Prozesse – kompakt erklärt.";

const fallbackImage = "/og/autaxo-og.png";

/** Robust canonical */
const canonicalUrl = (() => {
  try {
    if (Astro.site) return new URL(Astro.url.pathname, Astro.site).toString();
  } catch (_) {}
  return "https://www.autaxo.de/blog/";
})();
const pageUrl = canonicalUrl.endsWith("/") ? canonicalUrl : `${canonicalUrl}/`;

/** Posts aus Content Collection */
const entries = await getCollection("blog");

// Helper: Datum robust
function safeDate(value: unknown): Date {
  const s = typeof value === "string" ? value : "";
  const d = new Date(s);
  return isNaN(d.getTime()) ? new Date("1970-01-01") : d;
}

// Normalisieren + sortieren
const posts = entries
  .map((p) => {
    // ✅ ROUTING-SLUG immer aus Dateiname
    const url = `/blog/${p.slug}/`;

    const dateObj = safeDate(p.data.datePublished);
    const dateIso = typeof p.data.datePublished === "string" ? p.data.datePublished : "1970-01-01";

    return {
      url,
      slug: p.slug,
      title: p.data.title,
      excerpt: p.data.excerpt ?? p.data.metaDescription ?? "",
      date: dateIso,
      dateObj,
      image: (p.data.coverImage && String(p.data.coverImage).length > 0) ? p.data.coverImage : null,
      tags: Array.isArray(p.data.tags) ? p.data.tags : [],
    };
  })
  .sort((a, b) => (a.dateObj < b.dateObj ? 1 : -1));

/** Themen (Filter-Chips + Link zu /blog/themen) */
const topics = [
  { label: "§25a", key: "25a", tokens: ["§25a", "differenzbesteuerung", "ustg"] },
  { label: "DATEV", key: "datev", tokens: ["datev", "skr03", "skr04", "buchhaltung"] },
  { label: "GoBD", key: "gobd", tokens: ["gobd", "dokumentation", "aufbewahrung"] },
  { label: "EU/Export", key: "eu-export", tokens: ["eu", "export", "igl", "vies", "gelangens"] },
  { label: "Nachweise", key: "nachweise", tokens: ["nachweis", "gelangens", "beleg", "dokument"] },
  { label: "Workflow", key: "workflow", tokens: ["workflow", "fin", "scan", "prozess"] },
];

/** Structured data */
const schema = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "BreadcrumbList",
      "@id": `${pageUrl}#breadcrumb`,
      "itemListElement": [
        { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://www.autaxo.de/" },
        { "@type": "ListItem", "position": 2, "name": "Blog", "item": pageUrl }
      ]
    },
    {
      "@type": "Blog",
      "@id": `${pageUrl}#blog`,
      "name": title,
      "description": description,
      "url": pageUrl
    },
    {
      "@type": "ItemList",
      "@id": `${pageUrl}#posts`,
      "itemListOrder": "https://schema.org/ItemListOrderDescending",
      "numberOfItems": posts.length,
      "itemListElement": posts.map((p, i) => ({
        "@type": "ListItem",
        "position": i + 1,
        "url": `https://www.autaxo.de${p.url}`,
        "item": {
          "@type": "BlogPosting",
          "headline": p.title,
          "description": p.excerpt,
          "datePublished": p.date,
          "image": p.image ? p.image : `https://www.autaxo.de${fallbackImage}`,
          "mainEntityOfPage": `https://www.autaxo.de${p.url}`
        }
      }))
    }
  ]
};
---

<MarketingLayout title={title} description={description} canonicalUrl={canonicalUrl} image={fallbackImage}>
  <script type="application/ld+json" slot="head" set:html={JSON.stringify(schema)} />

  <section class="relative pt-32 pb-14 bg-[#0b0c10] overflow-hidden">
    <div class="absolute top-0 left-1/2 -translate-x-1/2 w-[900px] h-[520px] bg-primary/10 blur-[140px] rounded-full pointer-events-none -z-10"></div>

    <div class="container mx-auto px-4 max-w-5xl text-center relative">
      <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/5 border border-white/10 text-primary text-sm font-medium mb-6">
        <Icon name="lucide:book-open" class="w-4 h-4" />
        Autaxo Blog
      </div>

      <h1 class="text-4xl md:text-6xl font-extrabold text-white mb-5 tracking-tight leading-tight">
        Praxiswissen zu <br />
        <span class="text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-red-400">§25a, DATEV, GoBD</span>
        <br class="hidden md:block" />
        und EU/Export im Gebrauchtwagenhandel
      </h1>

      <p class="text-lg md:text-xl text-white/70 leading-relaxed max-w-4xl mx-auto">
        Für Gebrauchtwagenhändler in Deutschland: Steuerthemen (UStG), Nachweise (EU/Export), GoBD-Dokumentation und
        Buchhaltungsprozesse – verständlich und praxisnah.
      </p>

      <div class="mt-9 max-w-2xl mx-auto">
        <div class="relative">
          <Icon name="lucide:search" class="w-5 h-5 text-white/40 absolute left-4 top-1/2 -translate-y-1/2" />
          <input
            id="blog-search"
            type="text"
            placeholder="Artikel durchsuchen (z. B. §25a, DATEV, Export, GoBD)…"
            class="w-full pl-12 pr-4 py-3 rounded-xl bg-white/5 border border-white/10 text-white placeholder:text-white/40 focus:outline-none focus:border-primary/50"
          />
        </div>
      </div>

      <div class="mt-6 flex flex-wrap gap-2 justify-center" aria-label="Themen">
        <button
          type="button"
          class="ax-topic-chip is-active inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white/5 border border-white/10 text-white/80 hover:text-white hover:border-primary/40 transition-colors text-sm"
          data-topic="all"
        >
          <Icon name="lucide:layers" class="w-4 h-4 text-primary" />
          Alle Themen
        </button>

        {topics.map((t) => (
          <button
            type="button"
            class="ax-topic-chip inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white/5 border border-white/10 text-white/80 hover:text-white hover:border-primary/40 transition-colors text-sm"
            data-topic={t.key}
            data-tokens={t.tokens.join(" ").toLowerCase()}
          >
            <Icon name="lucide:tag" class="w-4 h-4 text-white/40" />
            {t.label}
          </button>
        ))}

        <a
          href="/blog/themen"
          class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-white/5 border border-white/10 text-white/80 hover:text-white hover:border-primary/40 transition-colors text-sm"
        >
          <Icon name="lucide:compass" class="w-4 h-4 text-primary" />
          Themenübersicht
        </a>
      </div>
    </div>
  </section>

  <main class="pb-24 bg-[#0b0c10]">
    <div class="container mx-auto px-4 max-w-5xl">
      <ol class="space-y-4" id="blog-list" aria-label="Blogartikel">
        {posts.map((post) => (
          <li data-post-row data-title={post.title.toLowerCase()} data-tags={(post.tags || []).join(" ").toLowerCase()}>
            <article class="group rounded-2xl border border-white/10 bg-[#15171e] hover:border-primary/50 transition-all overflow-hidden">
              <a href={post.url} class="block">
                <div class="grid md:grid-cols-12 gap-0 md:gap-6">
                  <div class="md:col-span-4 bg-black/30">
                    <img
                      src={post.image || fallbackImage}
                      alt={post.title}
                      loading="lazy"
                      decoding="async"
                      class="w-full h-full object-cover aspect-[16/9] md:aspect-auto md:min-h-[170px] opacity-90 group-hover:opacity-100 transition-opacity"
                    />
                  </div>

                  <div class="md:col-span-8 p-6 md:py-7 md:pr-7 md:pl-0">
                    <div class="flex flex-wrap items-center gap-2 text-xs mb-3">
                      <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-white/5 border border-white/10 text-white/70">
                        <Icon name="lucide:calendar" class="w-3.5 h-3.5 text-white/40" />
                        {new Date(post.dateObj).toLocaleDateString("de-DE", { year: "numeric", month: "long", day: "2-digit" })}
                      </span>

                      {(post.tags || []).slice(0, 3).map((t) => (
                        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-white/5 border border-white/10 text-white/70">
                          <Icon name="lucide:tag" class="w-3.5 h-3.5 text-white/40" />
                          {t}
                        </span>
                      ))}
                    </div>

                    <h3 class="text-xl md:text-2xl font-extrabold text-white leading-snug group-hover:text-primary transition-colors">
                      {post.title}
                    </h3>

                    {post.excerpt && <p class="mt-3 text-text-muted leading-relaxed">{post.excerpt}</p>}

                    <div class="mt-4 inline-flex items-center gap-2 text-primary font-bold">
                      Weiterlesen
                      <Icon name="lucide:arrow-right" class="w-4 h-4 transition-transform group-hover:translate-x-0.5" />
                    </div>
                  </div>
                </div>
              </a>
            </article>
          </li>
        ))}
      </ol>
    </div>
  </main>

  <script is:inline>
    const search = document.getElementById('blog-search');
    const rows = Array.from(document.querySelectorAll('[data-post-row]'));
    const chips = Array.from(document.querySelectorAll('.ax-topic-chip'));

    let activeTopic = 'all';
    let activeTokens = '';

    function normalize(s){ return (s || '').toLowerCase().trim(); }

    function setActiveChip(key){
      chips.forEach((c) => {
        const k = c.getAttribute('data-topic');
        c.classList.toggle('is-active', k === key);
      });
    }

    function tokenMatch(hay, tokens){
      if (!tokens) return true;
      const parts = tokens.split(' ').filter(Boolean);
      return parts.some((p) => hay.includes(p));
    }

    function apply(){
      const q = normalize(search?.value);
      rows.forEach((r) => {
        const title = r.getAttribute('data-title') || '';
        const tags  = r.getAttribute('data-tags') || '';
        const hay = (title + ' ' + tags);

        const qOk = (!q || hay.includes(q));
        const topicOk = (activeTopic === 'all') ? true : tokenMatch(hay, activeTokens);

        r.style.display = (qOk && topicOk) ? '' : 'none';
      });
    }

    chips.forEach((c) => {
      c.addEventListener('click', () => {
        activeTopic = (c.getAttribute('data-topic') || 'all');
        activeTokens = (c.getAttribute('data-tokens') || '');
        setActiveChip(activeTopic);
        apply();
      });
    });

    search?.addEventListener('input', apply);

    setActiveChip('all');
    apply();
  </script>

  <style>
    .ax-topic-chip.is-active{
      color: rgba(255,255,255,1);
      border-color: rgba(179,0,24,.55) !important;
      background: rgba(179,0,24,.08) !important;
    }
  </style>
</MarketingLayout>
